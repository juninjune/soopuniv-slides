name: PDF to Slides Converter

on:
  schedule:
    - cron: '0 * * * *'  # 매 정시마다 (1시간 폴링)
  workflow_dispatch:       # GitHub 웹 UI에서 수동 실행

permissions:
  contents: write          # 커밋/푸시에 필요

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      # --- 저장소 체크아웃 ---
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Dropbox에서 최신 PDF 확인 및 다운로드 ---
      - name: Check Dropbox for PDF
        id: dropbox
        env:
          DROPBOX_ACCESS_TOKEN: ${{ secrets.DROPBOX_ACCESS_TOKEN }}
        run: |
          echo "=== Dropbox 폴더 확인 ==="

          # App folder 루트의 파일 목록 조회
          RESPONSE=$(curl -s -X POST \
            https://api.dropboxapi.com/2/files/list_folder \
            -H "Authorization: Bearer $DROPBOX_ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"path": "", "recursive": false}')

          # PDF 파일 필터링 (가장 최근 수정된 것)
          PDF_ENTRY=$(echo "$RESPONSE" | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          entries = data.get('entries', [])
          pdfs = [e for e in entries if e.get('name', '').lower().endswith('.pdf')]
          if not pdfs:
              print('NONE')
          else:
              # 가장 최근 수정된 PDF 선택
              latest = max(pdfs, key=lambda e: e.get('server_modified', ''))
              print(json.dumps(latest))
          ")

          if [ "$PDF_ENTRY" = "NONE" ]; then
            echo "PDF 파일 없음. 종료."
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          PDF_NAME=$(echo "$PDF_ENTRY" | python3 -c "import json,sys; print(json.load(sys.stdin)['name'])")
          PDF_PATH=$(echo "$PDF_ENTRY" | python3 -c "import json,sys; print(json.load(sys.stdin)['path_lower'])")
          PDF_HASH=$(echo "$PDF_ENTRY" | python3 -c "import json,sys; print(json.load(sys.stdin).get('content_hash',''))")

          echo "발견: $PDF_NAME (hash: $PDF_HASH)"
          echo "found=true" >> $GITHUB_OUTPUT
          echo "pdf_name=$PDF_NAME" >> $GITHUB_OUTPUT
          echo "pdf_path=$PDF_PATH" >> $GITHUB_OUTPUT
          echo "pdf_hash=$PDF_HASH" >> $GITHUB_OUTPUT

          # 이전 해시와 비교 (변경 없으면 스킵)
          if [ -f ".last_pdf_hash" ]; then
            LAST_HASH=$(cat .last_pdf_hash)
            if [ "$PDF_HASH" = "$LAST_HASH" ]; then
              echo "PDF 변경 없음 (hash 동일). 스킵."
              echo "changed=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          echo "changed=true" >> $GITHUB_OUTPUT

          # PDF 다운로드
          echo "=== PDF 다운로드 ==="
          curl -s -X POST \
            https://content.dropboxapi.com/2/files/download \
            -H "Authorization: Bearer $DROPBOX_ACCESS_TOKEN" \
            -H "Dropbox-API-Arg: {\"path\": \"$PDF_PATH\"}" \
            -o "input.pdf"

          ls -lh input.pdf

      # --- 변경 없으면 이후 단계 스킵 ---
      - name: Skip if no changes
        if: steps.dropbox.outputs.found != 'true' || steps.dropbox.outputs.changed != 'true'
        run: echo "변경 없음. 워크플로우 종료."

      # --- Python 환경 설정 ---
      - name: Setup Python
        if: steps.dropbox.outputs.changed == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # --- 의존성 설치 ---
      - name: Install dependencies
        if: steps.dropbox.outputs.changed == 'true'
        run: |
          sudo apt-get update && sudo apt-get install -y poppler-utils
          pip install pdf2image Pillow

      # --- PDF → 이미지 변환 ---
      - name: Convert PDF to slides
        if: steps.dropbox.outputs.changed == 'true'
        run: python scripts/convert_pdf.py input.pdf

      # --- 해시 파일 저장 (다음 실행 시 비교용) ---
      - name: Save PDF hash
        if: steps.dropbox.outputs.changed == 'true'
        run: echo "${{ steps.dropbox.outputs.pdf_hash }}" > .last_pdf_hash

      # --- Git 커밋 & 푸시 ---
      - name: Commit and push
        if: steps.dropbox.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add Web/slides/ Web/meta.json .last_pdf_hash
          git commit -m "slides: ${{ steps.dropbox.outputs.pdf_name }} 변환 반영"
          git push
